name: Deploy AdonisJS to cPanel

on:
  push:
    branches:
      - master # Déclenche le déploiement sur chaque push sur master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js (Version recommandée par cPanel)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Utilisez '20' ou '22'
          cache: 'npm'

      # 3. Installer les dépendances
      - name: Install dependencies
        run: npm ci

      # 4. Build l'application
      # Nous injectons les secrets requis pour la phase de compilation (ex: pour la signature des assets, même si l'APP_KEY est la plus critique)
      - name: Build application
        run: node ace build
        env:
          NODE_ENV: production
          APP_KEY: ${{ secrets.APP_KEY }}
          # On peut ajouter les variables de DB ici, bien qu'elles soient surtout utiles à l'exécution sur cPanel
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}

      # 5. Déployer via FTP
      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          # Secrets GitHub (identifiants d'accès au serveur)
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}

          # Chemin cible sur le serveur FTP (dossier de l'application)
          ftp-server-target: 	/home/nexiszjj

          # Déployer depuis la racine locale
          local-dir: ./

          # Fichiers et dossiers à EXCLURE du déploiement
          exclude: |
            .git*
            .github*
            node_modules/**
            .env*
            tsconfig.json
            eslint.config.js
            vite.config.ts
            adonisrc.ts
            package-lock.json
            tests/**
            inertia/**
            *.test.ts
            *.spec.ts
            README.md

      # 6. Notification de succès
      - name: Deploy Success
        if: success()
        run: echo "Déploiement réussi sur le serveur FTP!"

      # 7. Notification d'erreur
      - name: Deploy Failed
        if: failure()
        run: echo "Déploiement échoué - vérifiez les logs ci-dessus"
