name: Deploy AdonisJS to cPanel via SFTP

on:
  push:
    branches:
      - master # D√©clenche le d√©ploiement sur chaque push sur master

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: üéâ D√©ploiement Fullstack via SFTP

    steps:
      # 1. Checkout du code
      - name: üöö Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: üíª Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Version r√©cente et stable
          cache: 'npm'

      # 3. Installer les d√©pendances
      - name: üì¶ Install dependencies
        run: npm ci

      # 4. Build l'application Adonis/Inertia
      - name: üõ† Build application (Front + Back)
        run: node ace build
        env:
          NODE_ENV: production
          # Les secrets sont requis pour le build/signature des assets
          APP_KEY: ${{ secrets.APP_KEY }} 
          DB_HOST: ${{ secrets.DB_HOST }} 
          # ... autres secrets BDD ...

      # 5. D√©ployer via SFTP
      - name: üìÇ Upload Fullstack √† cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          # Secrets GitHub
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # Chemin cible sur le serveur FTP (dossier de l'application)
          server-dir: /home/nexiszjj/nexionconsultingdj.com/abdourahmanabdillahi/
          protocol: sftp 
          
          # ‚¨ÖÔ∏è C'est ici que l'on ajoute le port 22
          port: 22

          # D√©ployer depuis la racine locale
          local-dir: ./

          # Fichiers et dossiers √† EXCLURE du d√©ploiement
          # L'exclusion du .env est CL√â, car les variables sont g√©r√©es par cPanel
          exclude: |
            .git*
            .github*
            node_modules/**
            .env*
            tsconfig.json
            *.lock
            tests/**
            inertia/**
            README.md
            
      # 6. Notification de succ√®s
      - name: ‚úÖ Deploy Success
        if: success()
        run: echo "D√©ploiement SFTP termin√©. Red√©marrage requis sur cPanel."

      # 7. Notification d'erreur
      - name: ‚ùå Deploy Failed
        if: failure()
        run: echo "D√©ploiement √©chou√©. V√©rifiez les logs FTP/SFTP."
